# 内核编译工作流 - 在 Ubuntu 24.04 ARM 上运行
name: 内核编译

# 手动触发，可指定内核版本
on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: '内核版本号 (如 6.18)'
        required: true
        default: '6.18'
      package_format:
        description: '包格式'
        required: true
        default: 'deb'
        type: choice
        options:
          - deb
          - pkg.tar.zst

# 工作流配置
jobs:
  build-kernel:
    # 在 Ubuntu 24.04 ARM 上运行
    runs-on: ubuntu-24.04-arm

    # 设置超时时间为 360 分钟（6小时）
    timeout-minutes: 360

    # 设置权限，允许创建 Release
    permissions:
      contents: write   # 允许创建 Release 和上传文件
      packages: write   # 允许上传包（如果需要）

    # 定义环境变量
    env:
      BUILD_TIMESTAMP: ${{ format('{0}', github.run_id) }}-${{ github.run_number }}
      # 编译优化选项
      MAKEFLAGS: "-j$(nproc)"
      CC: "clang"
      LD: "ld.lld"
      AR: "llvm-ar"
      NM: "llvm-nm"
      OBJCOPY: "llvm-objcopy"
      OBJDUMP: "llvm-objdump"
      READELF: "llvm-readelf"
    
    steps:
      # 检出代码
      - name: 检出代码
        uses: actions/checkout@v4
      
      # 安装编译依赖
      - name: 安装编译依赖
        run: |
          sudo apt update
          sudo apt install -y build-essential gcc-aarch64-linux-gnu bc flex bison \
          7zip kmod bash cpio binutils tar git wget dpkg libssl-dev clang llvm lld \
          libelf-dev python3 rsync
      
      # 设置 ccache 缓存
      - name: 设置 ccache
        uses: actions/cache@v3
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-kernel-${{ inputs.kernel_version }}-${{ inputs.package_format }}-${{ hashFiles('raphael-kernel_build.sh', 'raphael-kernel-arch_build.sh') }}
          restore-keys: |
            ${{ runner.os }}-ccache-kernel-${{ inputs.kernel_version }}-${{ inputs.package_format }}-
            ${{ runner.os }}-ccache-kernel-${{ inputs.kernel_version }}-
            ${{ runner.os }}-ccache-kernel-
      
      # 安装并配置 ccache
      - name: 安装配置 ccache
        run: |
          sudo apt install -y ccache
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=5G" >> $GITHUB_ENV
          echo "PATH=/usr/lib/ccache:$PATH" >> $GITHUB_ENV
      
      # 编译内核
      - name: 编译内核
        env:
          CCACHE_DIR: ${{ env.CCACHE_DIR }}
          PATH: ${{ env.PATH }}
        run: |
          # 导出 ccache 环境变量
          export CCACHE_DIR="$HOME/.ccache"
          export PATH="/usr/lib/ccache:$PATH"
          
          # 显示编译环境信息
          echo "=========================================="
          echo "编译环境信息"
          echo "=========================================="
          echo "系统信息:"
          uname -a
          echo ""
          echo "编译器版本:"
          clang --version | head -3
          echo ""
          echo "链接器版本:"
          ld.lld --version | head -3
          echo ""
          echo "可用内存:"
          free -h
          echo ""
          echo "可用磁盘空间:"
          df -h .
          echo "=========================================="
          echo ""
          
          # 设置编译超时和进度显示
          echo "开始编译内核 (超时: 6小时)..."
          echo "=========================================="
          
          # 根据包格式执行对应的构建脚本
          if [[ "${{ inputs.package_format }}" == "pkg.tar.zst" ]]; then
            echo "构建 Arch Linux 格式内核包..."
            if ! sudo timeout 6h sh raphael-kernel-arch_build.sh ${{ inputs.kernel_version }}; then
              echo "=========================================="
              echo "编译失败！显示最后 200 行日志:"
              echo "=========================================="
              if [ -f linux/compile.log ]; then
                tail -200 linux/compile.log
              else
                echo "未找到编译日志文件"
              fi
              exit 1
            fi
          else
            echo "构建 Debian 格式内核包..."
            if ! sudo timeout 6h sh raphael-kernel_build.sh ${{ inputs.kernel_version }}; then
              echo "=========================================="
              echo "编译失败！显示最后 200 行日志:"
              echo "=========================================="
              if [ -f linux/compile.log ]; then
                tail -200 linux/compile.log
              else
                echo "未找到编译日志文件"
              fi
              exit 1
            fi
          fi
          
          echo "=========================================="
          echo "编译成功完成！"
          echo "=========================================="
      
      # 获取当前时间戳
      - name: 获取构建时间
        id: get-timestamp
        run: |
          echo "timestamp=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
      
      # 列出编译产物
      - name: 列出编译产物
        run: |
          echo "编译产物列表:"
          ls -la *.deb *.pkg.tar.zst 2>/dev/null || echo "未找到编译产物"
      
      # 创建 GitHub Release 并上传编译产物
      - name: 创建 Release 并上传产物
        uses: softprops/action-gh-release@v1
        with:
          tag_name: kernel-v${{ inputs.kernel_version }}
          name: "xiaomi raphael linux内核 v${{ inputs.kernel_version }}"
          body: |
            xiaomi raphael linux内核
            - 版本: ${{ inputs.kernel_version }}
            - 包格式: ${{ inputs.package_format }}
            - 构建时间: ${{ steps.get-timestamp.outputs.timestamp }}
            - 构建 ID: ${{ env.BUILD_TIMESTAMP }}
          draft: false
          prerelease: false
          files: |
            *.deb
            *.pkg.tar.zst
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # 上传编译产物作为工作流制品
      - name: 上传内核包作为工作流制品
        uses: actions/upload-artifact@v4
        with:
          name: kernel-packages-${{ inputs.package_format }}-v${{ inputs.kernel_version }}
          path: |
            *.deb
            *.pkg.tar.zst
      
      # 上传编译日志（仅在编译失败时）
      - name: 上传编译日志
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: compile-logs-${{ inputs.package_format }}-v${{ inputs.kernel_version }}
          path: |
            linux/compile.log
            linux-xiaomi-raphael-*/boot/
          retention-days: 7